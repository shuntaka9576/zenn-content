---
title: "Jestã§Twitter OAuth 2.0ã®èªå¯ã‚³ãƒ¼ãƒ‰å–å¾—å‡¦ç†ã‚’è‡ªå‹•åŒ–ã™ã‚‹"
emoji: "ğŸ”“"
type: "tech"
topics: ["jest"]
published: true
---


# å‰æ

* Twitterã®`OAuth 2.0 Authorization Code Flow with PKCE`ã‚’åˆ©ç”¨
  * \+ Confidential Clientã‚’åˆ©ç”¨(not Public Client)
* Confidential Clientã®HTTP APIã®E2Eãƒ†ã‚¹ãƒˆã§å¿…è¦ãªèªå¯ã‚³ãƒ¼ãƒ‰å–å¾—å‡¦ç†ã‚’è‡ªå‹•åŒ–

# è‡ªå‹•ãƒ†ã‚¹ãƒˆã—ãŸã„ç®‡æ‰€

Twitterã®`OAuth 2.0 Authorization Code Flow with PKCE`ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ•ãƒ­ãƒ¼ã¨ãªã‚Šã¾ã™ã€‚è©³ç´°ã¯ã€[Developer Platform](https://developer.twitter.com/en/docs/authentication/oauth-2-0/authorization-code)ãŒå‚è€ƒã«ãªã‚Šã¾ã™


![img](https://res.cloudinary.com/dkerzyk09/image/upload/v1646471542/blog/5b9ea7521c7522c5ab0b/ij5bbja7en3wpdxubqrg.svg)
:::details plantuml

```plantuml
@startuml
title Twitter OAuth 2.0 Authorization Code Flow with PKCE
actor "User" as user
box "YourWebApp" #dee6ee
  participant "ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸" as webAppTopPage
end box
box "YourServerSide" #e6e6fa
  participant "HTTP API" as httpApi
end box
box "Twitter" #2bc4ff
  participant "Twitterèªå¯ç”»é¢" as twAuth
  participant "Twitterèªå¯ã‚µãƒ¼ãƒãƒ¼" as twServer
  participant "TwitterAPI" as twApi
end box
activate webAppTopPage
activate user
user->webAppTopPage: login with Twitterã‚’æŠ¼ä¸‹
webAppTopPage->webAppTopPage: code_verifierç”Ÿæˆ
webAppTopPage->webAppTopPage: code_verifierã‹ã‚‰code_challengeç”Ÿæˆ
webAppTopPage->twAuth: code_challenge
activate twAuth
twAuth->twAuth: èªå¯ç”»é¢ã‚’è¡¨ç¤º
twAuth-->user
deactivate twAuth
user->user: ã€Œã‚¢ãƒ—ãƒªã«ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã€ã‚’æŠ¼ä¸‹
user->twServer
activate twServer
twServer-->twServer: YourWebAppã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯URLã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
twServer-->webAppTopPage: authraization_code
deactivate twServer
webAppTopPage->httpApi: authraization_code, code_verifier
activate httpApi
httpApi->twServer: authraization_code, code_verifier, clientSecret
activate twServer
twServer-->httpApi: accessToken
deactivate twServer
httpApi->twApi: èªå¯æƒ…å ±ã®å–å¾—
activate twApi
twApi-->httpApi: å–å¾—OK
@enduml
```
:::

å›³ã®YourServerSideã®HTTP APIã§ã¯ã€èªå¯ã‚³ãƒ¼ãƒ‰(`authraization_code`)ã‚’å—ã‘å–ã‚‹å¿…è¦ãŒã‚ã‚Šã€ã“ã®èªå¯ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã¯æ‰‹å‹•ã§ãƒãƒãƒãƒã‚„ã‚‹ã®ãŒçµæ§‹é¢å€’ã§ã™ã€‚ä»Šå›ã¯ã€ã“ã®æ‰‹å‹•ãƒãƒãƒãƒã‚’[puppeteer](https://github.com/puppeteer/puppeteer)ã¨[jest](https://github.com/facebook/jest)ã‚’åˆ©ç”¨ã—ã¦è‡ªå‹•åŒ–ã—ã¾ã™ã€‚

:::message
Playwrightã‚„Cypressã‚’ä½¿ã†æ¡ˆã‚‚è€ƒãˆã¾ã—ãŸãŒã€ãƒ†ã‚¹ãƒˆãƒ„ãƒ¼ãƒ«åŒæ¢±ã§ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ãƒ†ã‚¹ãƒˆã‚’ã™ã‚‹ã‚ã‘ã§ã¯ãªã„ã®ã§ã€ãƒ©ã‚¤ãƒˆã«åˆ©ç”¨ã§ãã‚‹puppeteerã‚’æ¡ç”¨ã—ã¾ã—ãŸã€‚
:::

## å®Ÿè£…

ã‚³ãƒ¡ãƒ³ãƒˆã«ã¦è£œè¶³ã—ã¾ã™

```ts:puppeteerã‚’èµ·å‹•ã—ã€èªå¯ç”»é¢ã‚’æŠ¼ä¸‹ã™ã‚‹ã‚³ãƒ¼ãƒ‰
import * as Puppeteer from 'puppeteer';
import * as chrome from 'chrome-cookies-secure';

// PKCEã«å¿…è¦ãªcodeVerifier,codeChallengeç”Ÿæˆã™ã‚‹é–¢æ•°ã§ã™(å¾Œè¿°)
import { generateCodeChallenge, generateRandomString } from './text';

const codeVerifier = generateRandomString(45);
const codeChallenge = generateCodeChallenge(codeVerifier);

const COOKIE_URL = 'https://twitter.com';
// æœ¬ã‚³ãƒ¼ãƒ‰ã§æŒ‡å®šã—ãŸChromeã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã§ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã®Twitterã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ã‚¢ãƒ—ãƒªã«å¯¾ã—èªå¯ã‚’ä¸ãˆã‚‹ã“ã¨ã«ãªã‚Šã¾ã™
// Chromeã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã¯ã€chrome://versionã§ç¢ºèªã§ãã¾ã™
const CHROME_PROFILE_NAME = 'Default';
const AUTH_BUTTON_SELECTOR = '<èªå¯ãƒœã‚¿ãƒ³ã®ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼>'
const TWITTER_AUTH_ENDPOINT =
  'https://twitter.com/i/oauth2/authorize?response_type=code&' +
  'client_id=<ClientId>&' +
  'redirect_uri=<ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURL>&' + // listenã—ã¦ãªã„ã¨NG(*1)
  'scope=tweet.read%20users.read%20offline.access&' +
  'state=<state>&' +
  `code_challenge=${codeChallenge}&` +
  'code_challenge_method=s256';
const JEST_TIMEOUT_MILLSECS = 5 * 60 * 1000;

jest.setTimeout(JEST_TIMEOUT_MILLSECS);

interface Cookie {
  name: string;
  value: string;
  expires: number;
  domain: string;
  path: string;
  Secure: boolean;
}

// é€šå¸¸puppeteerã¯sandboxã‚’ç«‹ã¡ä¸Šã’ã‚‹ãŸã‚ã€Twitterã¸ãƒ­ã‚°ã‚¤ãƒ³ã—ç›´ã™å¿…è¦ãŒã‚ã‚Šã¾ã™ãŒã€ä»Šå›ã¯çœç•¥ã™ã‚‹ä½œã‚Šã«ãªã£ã¦ã„ã¾ã™
// ç¬¬ä¸€å¼•æ•°ã«Chromeã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šã—ã€ç¬¬äºŒå¼•æ•°ã«ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã§å–å¾—ã™ã‚‹Cookieæƒ…å ±ã®URLã‚’æŒ‡å®šã—ã¾ã™
const getCookies = (profile: string, url: string): Promise<Cookie[]> => {
  return new Promise((resolve, reject) => {
    chrome.getCookies(
      url,
      'puppeteer',
      (err: Error, cookies: Cookie[]) => {
        err ? reject(err) : resolve(cookies);
      },
      profile,
    );
  });
};

export const readyTwitterAuthGrant = async () => {
  const browser = await Puppeteer.launch({
    headless: false,
  });
  // https://twitter.comã®Cookieæƒ…å ±ã‚’å–å¾—
  const cookies = await getCookies(CHROME_PROFILE_NAME, COOKIE_URL);
  const page = await browser.newPage();
  // puppeteerã®sandboxç’°å¢ƒã«Cookieæƒ…å ±ã‚’ã‚»ãƒƒãƒˆ
  await page.setCookie(...cookies);
  await page.goto(TWITTER_AUTH_ENDPOINT);

  const authButton = await page.waitForSelector(AUTH_BUTTON_SELECTOR);
  if (!authButton) {
    throw new Error('AUTH_BUTTON_SELECTOR changed?');
  }
  await authButton.click(); // YourWebAppã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
  await page.waitForNavigation(); // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå¾…ã¡
  const redirectUri = page.url(); // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURLã‚’å–å¾—
  const url = new URL(redirectUri);
  const tmpState = url.searchParams.get('state');
  const tmpCode = url.searchParams.get('code'); // èªå¯ã‚³ãƒ¼ãƒ‰å–å¾—
  if (!(tmpState && tmpCode)) {
    throw new Error();
  }

  return {
    data: {
      authCode: tmpCode,
      codeVerifier: codeVerifier,
    },
    tearDown: async () => {
      await browser.close();
    },
  };
};
```

*1 YourWebAppã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹URLãŒéåˆ°é”ã®å ´åˆã¯ã€ä»¥ä¸‹ã‚³ãƒ¼ãƒ‰ã§ä¸¡å¯¾å¿œå¯

:::details ã‚³ãƒ¼ãƒ‰ã‚’å±•é–‹ã™ã‚‹
```ts
const redirectUri = await (async (): Promise<string> => {
  const isValidUrl = (url: string) => {
    const parsedEventUrl = new URL(url);
    if (parsedEventUrl.host === REDIRECT_HOST) {
      return true;
    }
    return false;
  };

  return new Promise((resolve) => {
    // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå…ˆãŒéåˆ°é”ãªURLã®å ´åˆ
    page.on('requestfailed', async (req) => {
      const eventUrl = req.url();
      if (isValidUrl(eventUrl)) {
        resolve(eventUrl);
      }
    });
    // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå…ˆãŒåˆ°é”å¯èƒ½ãªURLã®å ´åˆ
    page.on('response', async (res) => {
      const eventUrl = res.url();
      if (isValidUrl(eventUrl)) {
        resolve(eventUrl);
      }
    });
  });
})();
```
:::


```ts:codeVerifier,codeChallengeã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
import * as crypto from 'crypto';

export const generateRandomString = (length: number) => {
  let text = '';
  const possible =
    'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';

  for (let i = 0; i < length; i++) {
    text += possible.charAt(Math.floor(Math.random() * possible.length));
  }

  return text;
};

export const generateCodeChallenge = (codeVerifier: string) => {
  const challenge = crypto
    .createHash('sha256')
    .update(codeVerifier)
    .digest('base64')
    .replace(/=/g, '')
    .replace(/\+/g, '-')
    .replace(/\//g, '_');

  return challenge;
};
```

```ts:èªå¯ã‚³ãƒ¼ãƒ‰ã‚’é€ä¿¡ã™ã‚‹å…ˆã®HTTP APIã®ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰
import { readyTwitterAuthGrant } from './helpers/auth';

let data: { authCode: string; codeVerifier: string };
let tearDown: () => Promise<void>;

beforeAll(async () => {
  const res = await readyTwitterAuthGrant();
  data = res.data;
  tearDown = res.tearDown;
});

afterAll(async () => {
  await tearDown(); // sandobxã®åœæ­¢
});

describe('èªå¯APIã¸authCodeã‚’é€ä¿¡ã™ã‚‹', () => {
  test('Return 200', async () => {
    // data.authCode, data.codeVerifierã‚’HTTP APIã«é€ä¿¡ã—ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ç¢ºèª(çœç•¥)
  });
});
```

# èª²é¡Œ

* headlessã«ã™ã‚‹ã¨å¤±æ•—ã™ã‚‹

# æœ€å¾Œã«
ã¨ã‚Šã‚ãˆãšå¿«é©ã«ãƒ†ã‚¹ãƒˆã§ããã†ã§ã™ã€‚ã‚‚ã£ã¨è‰¯ã„æ–¹æ³•ã‚ã‚Šãã†ãªæ°—ãŒã—ã¦ãªã‚‰ãªã„ã§ã™ãŒã€ã€ã‚ã‚Šã¾ã—ãŸã‚‰ã”æ•™æˆã„ãŸã ã‘ã‚‹ã¨å¬‰ã—ã„ã§ã™ã€‚

# å‚è€ƒ
Twitterå…¬å¼ã¨ä»¥ä¸‹ã®è¨˜äº‹ã§ãƒ•ãƒ­ãƒ¼ã«é–¢ã—ã¦ã®ç†è§£ãŒæ·±ã¾ã‚Šã¾ã—ãŸã€‚ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼

* [Twitter OAuth2.0ã®è¨­å®šã‚„å‹•ä½œã¾ã¨ã‚](https://zenn.dev/kg0r0/articles/8b1cfe654a1cee)

