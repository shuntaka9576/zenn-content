---
title: "Litestream on App Runnerã§S3ã«SQLiteã‚’ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ãƒˆã—ã¤ã¤ã‚¢ãƒ—ãƒªã‚’ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã™ã‚‹"
emoji: "ğŸ’¡"
type: "tech"
topics: ["litestream", "apprunner"]
published: true
---

# ã¯ã˜ã‚ã«

ä»Šå›ã¯ã€SQLiteã‚’ä½¿ã£ãŸWebã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’[AWS App Runner](https://aws.amazon.com/jp/apprunner/)ä¸Šã«ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã—ã¾ã™ã€‚åŒæ™‚ã«å°‘ã—å‰è©±é¡Œã«ãªã£ãŸSQLiteã‚’Amazon S3ã«ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ãã‚‹[Litestream](https://litestream.io/)ã‚’ç”¨ã„ã¦S3ã«ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ¬ãƒ—ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã—ã¦ã¿ã¾ã™ã€‚
ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚„å€‹äººé–‹ç™ºã§ã€ãƒãƒãƒ¼ã‚¸ãƒ‰RDBMSã‚’åˆ©ç”¨ã›ãšã€æ–™é‡‘æŠ‘ãˆãŸã„å ´åˆã«ä½¿ãˆã‚‹ã‹ãªãƒ¼ã¨è€ƒãˆã€App Runnerã®ç´ æŒ¯ã‚Šã‚‚å…¼ã­ã¦è©¦ã—ã¦ã¿ã¾ã—ãŸã€‚

# æœ¬æ§‹æˆã«ãŠã‘ã‚‹æ³¨æ„ç‚¹

App Runnerã®ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å†…ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã®ç‰¹æ€§ã¯ã€[AWS App Runner Developer Guide](https://docs.aws.amazon.com/apprunner/latest/dg/develop.html)ã‹ã‚‰ã€å¼•ç”¨ã—ã¾ã™
> Storage â€“ App Runner implements the file system in your container instance as ephemeral storage. Files are transient. For example, they don't persist when you pause and resume your App Runner service. More generally, files aren't guaranteed to persist beyond the processing of a single request, as part of the stateless nature of your application. Stored files do, however, take up part of the storage allocation of your App Runner service for the duration of their lifespan.
> Note
> Although ephemeral storage files might not persist across requests, they sometimes do persist. This can be useful in certain situations. For example, when handling a request, you can cache files that your application downloads if future requests might need them. This might speed up future request handling, but can't guarantee the speed gains. Your code shouldn't assume that a file that has been downloaded in a previous request still exists.

ä»¥ä¸Šã‚’ç§ã®è¨€è‘‰ã§ã¾ã¨ã‚ã¦ã¿ã¾ã™ã€‚

1. ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã¯æ®ç™ºæ€§ãƒ‡ã‚£ã‚¹ã‚¯ã§ã€ãƒ•ã‚¡ã‚¤ãƒ«ã¯ä¸€æ™‚çš„
2. ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä¸€æ™‚åœæ­¢ã€å†é–‹ã—ã¦ã‚‚ãƒ•ã‚¡ã‚¤ãƒ«ã¯æŒç¶šã—ãªã„
3. 1ã¤ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å‡¦ç†ã‚’è¶…ãˆã¦ãƒ•ã‚¡ã‚¤ãƒ«ãŒæŒç¶šã™ã‚‹ã“ã¨ã¯ä¿è¨¼ã•ã‚Œã¦ã„ãªã„

1, 2ã¯ã€ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•æ™‚ã«S3ã‹ã‚‰Litestremã§ãƒªã‚¹ãƒˆã‚¢ã™ã‚Œã°ã‚ˆã„ã§ã™ãŒã€3ã«é–¢ã—ã¦ã¯ã©ã†ã—ã‚ˆã†ã‚‚ã‚ã‚Šã¾ã›ã‚“ã€‚ãŸã 3ã¯æŒç¶šã™ã‚‹å ´åˆã‚‚ã‚ã‚Šã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¨ã—ã¦æ´»ç”¨ã™ã‚‹ã‚±ãƒ¼ã‚¹ãŒç´¹ä»‹ã•ã‚Œã¦ã„ã¾ã™ã€‚
ä»¥ä¸Šã‚ˆã‚Šã€ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ®ç™ºã™ã‚‹å¯èƒ½æ€§ã‚’è¨±å®¹å¯èƒ½ã§ã‚ã‚Œã°æ´»ç”¨ã§ãã¾ã™ã€‚ã¾ãŸLitestreamã¯ã€ä»»æ„ã®é–“éš”ã§ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆå–å¾—å¯èƒ½ã§ã€ã‚¢ãƒ—ãƒªã§ãƒ­ã‚¸ãƒƒã‚¯ã‚’çµ„ã‚“ã§å¯¾ç­–ã‚‚ã§ãã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“(æœ¬è¨˜äº‹ã§ã¯å¯¾è±¡å¤–)ã€‚
ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«é–¢ã—ã¦ã¯ã€è¨˜è¼‰ã®æ›–æ˜§ã•ãŒæ®‹ã£ã¦ãŠã‚Šã€[ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—](https://github.com/aws/apprunner-roadmap/issues/112)ã§ã‚‚æ”¹å–„ãŒææ¡ˆã•ã‚Œã¦ã„ã¾ã™ã€‚æœ¬æ§‹æˆã¯[EFSãŒVPC ConnectorçµŒç”±ã§åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸå ´åˆ](https://github.com/aws/apprunner-roadmap/issues/14)ã¯ãã¡ã‚‰ã‚’æ´»ç”¨ã™ã‚‹ã®ãŒè‰¯ã„ã¨æ€ã„ã¾ã™ã€‚

:::message
æœ¬è¨˜äº‹ã‚’å…ƒã«ã‚·ã‚¹ãƒ†ãƒ ã‚’ä½œæˆã™ã‚‹å ´åˆã€ã€Œ1ã¤ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å‡¦ç†ã‚’è¶…ãˆã¦ãƒ•ã‚¡ã‚¤ãƒ«ãŒæŒç¶šã™ã‚‹ã“ã¨ã¯ä¿è¨¼ã•ã‚Œã¦ã„ãªã„ã“ã¨ã€ã‚’ç†è§£ã—ãŸä¸Šã§åˆ©ç”¨ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚
:::

# æ§‹æˆ

å‰è¿°ã—ãŸã¨ãŠã‚Šã€æ§‹æˆã¯ä»¥ä¸‹ã®å›³ã®é€šã‚Šã§ã™ã€‚

![image](https://user-images.githubusercontent.com/12817245/182011231-71dc9d62-df66-457c-b2eb-15806bc6f973.png)

ã‚³ãƒ³ãƒ†ãƒŠã®å‹•ä½œã¨ã—ã¦ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚‹ã“ã¨ãŒæ¨æ¸¬ã§ãã¾ã™ã€‚

|ã‚³ãƒ³ãƒ†ãƒŠ|æŒ™å‹•|
|---|---|
|èµ·å‹•æ™‚|S3ã‹ã‚‰DBã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã«ãƒªã‚¹ãƒˆã‚¢|
|èµ·å‹•ä¸­|S3ã¸DBã‚’ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ãƒˆ|
|åœæ­¢æ™‚|ãƒªãƒ—ãƒ¬ã‚±ãƒ¼ãƒˆåœæ­¢|
|å†é–‹æ™‚|S3ã‹ã‚‰DBã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã«ãƒªã‚¹ãƒˆã‚¢|

# æ§‹ç¯‰


## ãƒªãƒã‚¸ãƒˆãƒª

GitHubã«ã‚½ãƒ¼ã‚¹ã‚’å…¬é–‹ã—ã¦ã„ã¾ã™ã®ã§ã€cloneã—ãŸä¸Šã§ä½œæ¥­ã—ã¦é ‚ãã®ãŒè‰¯ã„ã¨æ€ã„ã¾ã™ã€‚README.mdã«[AWSç’°å¢ƒä½œæˆæ‰‹é †](https://github.com/shuntaka9576/go_api_sqlite#aws%E7%92%B0%E5%A2%83%E4%BD%9C%E6%88%90%E6%89%8B%E9%A0%86)ã‚’åˆ¥é€”ä¹—ã›ã¦ã„ã¾ã™ã®ã§ã€åˆã‚ã›ã¦ã”ç¢ºèªé ‚ã‘ãŸã‚‰å¹¸ã„ã§ã™ã€‚

[![shuntaka9576/go_api_sqlite - GitHub](https://gh-card.dev/repos/shuntaka9576/go_api_sqlite.svg)](https://github.com/shuntaka9576/go_api_sqlite)

## ECRä½œæˆ
[CDK](https://github.com/shuntaka9576/go_api_sqlite/tree/main/_cdk)ã‚’åˆ©ç”¨ã—ã¦ã€ECRä½œæˆ

```bash:ECRã®ä½œæˆ
yarn cdk deploy -c stageName=dev dev-go-api-sqlite-ecr
```

## Goã®APIã‚µãƒ³ãƒ—ãƒ«å…¥ã‚Šã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ECRã¸ç™»éŒ²
ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¾ã™ã€‚

```Dockerfile:Dockerfile
FROM golang:alpine AS build-stage
RUN apk add alpine-sdk
ADD . /app
WORKDIR /app
RUN go build -o app .

FROM alpine:latest
COPY --from=build-stage /app/app /usr/local/bin/app
ADD https://github.com/benbjohnson/litestream/releases/download/v0.3.8/litestream-v0.3.8-linux-amd64-static.tar.gz /tmp/litestream.tar.gz
RUN tar -C /usr/local/bin -xzf /tmp/litestream.tar.gz
COPY entrypoint.sh /usr/local/bin
COPY litestream.yml /etc/litestream.yml
RUN chmod +x /usr/local/bin/entrypoint.sh

ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]
```

```bash:entrypoint.sh
#!/bin/sh
echo "start container entry point"
set -e

if [ -f ./todo.db ]; then
  echo "delete $DB_PATH"
  rm $DB_PATH
fi

# ã‚¢ãƒ—ãƒªèµ·å‹•å‰ã«SQLiteã‚’ãƒªã‚¹ãƒˆã‚¢
litestream restore -v -if-replica-exists -o $DB_PATH s3://$REPLICATE_BUCKET_NAME/replica

# Litestreamã®ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ãƒˆã‚’å®Ÿè¡Œã—ã¤ã¤ã€APIã‚¢ãƒ—ãƒªã‚’èµ·å‹•
exec litestream replicate -exec "/usr/local/bin/app"
```

```bash:ã‚³ãƒ³ãƒ†ãƒŠãƒ“ãƒ«ãƒ‰
make build
# or docker build -t go-api-sqlite:latest
```

ä½œæˆã•ã‚ŒãŸECRã®URL(<ã‚¢ã‚«ã‚¦ãƒ³ãƒˆID>.dkr.ecr.ap-northeast-1.amazonaws.com)ã‚’æŒã¡ã„ã¦ã€

```bash
# ECRã¸ãƒ­ã‚°ã‚¤ãƒ³
aws ecr get-login-password --region ap-northeast-1 | docker login --username AWS --password-stdin <ã‚¢ã‚«ã‚¦ãƒ³ãƒˆID>.dkr.ecr.ap-northeast-1.amazonaws.com
# latestã‚¿ã‚°ã†ã¡
docker tag go-api-sqlite:latest <ã‚¢ã‚«ã‚¦ãƒ³ãƒˆID>.dkr.ecr.ap-northeast-1.amazonaws.com/go-api-sqlite:latest
# ã‚³ãƒ³ãƒ†ãƒŠã‚’ECRã¸push
docker push <ã‚¢ã‚«ã‚¦ãƒ³ãƒˆID>.dkr.ecr.ap-northeast-1.amazonaws.com/go-api-sqlite:latest
```

## App Runnerã®ä½œæˆ
è©³ã—ã„æ‰‹é †ã¯[ã“ã¡ã‚‰](https://github.com/shuntaka9576/go_api_sqlite#apprunner-with-s3%E3%82%92%E4%BD%9C%E6%88%90)

```bash
$ yarn cdk deploy -c stageName=dev dev-go-api-sqlite-app-runner 
...
Do you wish to deploy these changes (y/n)? y
dev-go-api-sqlite-app-runner: deploying...
[0%] start: Publishing 9f890b3b26c642c19b4bb1b96e6fc2a31bfa0dde3be73a897363b9b4c5614414:current_account-current_region
[100%] success: Published 9f890b3b26c642c19b4bb1b96e6fc2a31bfa0dde3be73a897363b9b4c5614414:current_account-current_region
dev-go-api-sqlite-app-runner: creating CloudFormation changeset...

 âœ…  dev-go-api-sqlite-app-runner

âœ¨  Deployment time: 341.31s

Outputs:
dev-go-api-sqlite-app-runner.AppRunnerOutput = https://<å€‹äºº>.ap-northeast-1.awsapprunner.com
curl -XGET https://<ãƒªã‚½ãƒ¼ã‚¹æ¯>.ap-northeast-1.awsapprunner.com/tasks
curl -XPOST https://<ãƒªã‚½ãƒ¼ã‚¹æ¯>.ap-northeast-1.awsapprunner.com/tasks -d '{"title": "test1"}'
Stack ARN:
arn:aws:cloudformation:ap-northeast-1:<ã‚¢ã‚«ã‚¦ãƒ³ãƒˆID>:stack/dev-go-api-sqlite-app-runner/f**

âœ¨  Total time: 348.17s
```

Outputsã§å‡ºåŠ›ã•ã‚ŒãŸã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã€çµæœãŒè¿”å´ã•ã‚ŒãŸã‚‰App Runnerã§æ­£å¸¸ã«ã‚¢ãƒ—ãƒªãŒå‹•ä½œã—ã¦ã„ã¾ã™ã€‚

```bash
$ curl -XPOST https://<ãƒªã‚½ãƒ¼ã‚¹æ¯>.ap-northeast-1.awsapprunner.com/tasks -d '{"title": "test1"}'
{"id":1}
$ curl -XPOST https://<ãƒªã‚½ãƒ¼ã‚¹æ¯>.ap-northeast-1.awsapprunner.com/tasks -d '{"title": "test1"}'
{"id":2}
$ curl -XGET https://<ãƒªã‚½ãƒ¼ã‚¹æ¯>.ap-northeast-1.awsapprunner.com/tasks
[{"id":1,"title":"test1","status":"todo","created":"2022-07-31 05:45:20"},{"id":2,"title":"test1","status":"todo","created":"2022-07-31 05:45:43"}]
```


## å‹•ä½œç¢ºèª

### ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã‹ã‚‰ãƒªã‚¹ãƒˆã‚¢
Litestreamã§SQLiteãŒãƒ¬ãƒ—ãƒªã‚±ãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹S3ã‚’æŒ‡å®šã—ã€ãƒ­ãƒ¼ã‚«ãƒ«PCã«DBã‚’ãƒªã‚¹ãƒˆã‚¢ã—ã¦ã¿ã¾ã™ã€‚

```bash
$ litestream restore -v -if-replica-exists -o todo.db s3://dev-go-api-sqlite-replica-<ã‚¢ã‚«ã‚¦ãƒ³ãƒˆID>/replica
2022/07/31 15:01:08.151456 s3: restoring snapshot 86de7c7a0d711718/00000003 to todo.db.tmp
2022/07/31 15:01:08.212286 s3: restoring wal files: generation=86de7c7a0d711718 index=[00000003,00000003]
2022/07/31 15:01:08.247536 s3: downloaded wal 86de7c7a0d711718/00000003 elapsed=35.202577ms
2022/07/31 15:01:08.269046 s3: applied wal 86de7c7a0d711718/00000003 elapsed=21.478191ms
2022/07/31 15:01:08.269072 s3: renaming database from temporary location

$ sqlite3 todo.db
SQLite version 3.32.3 2020-06-18 14:16:19
Enter ".help" for usage hints.
sqlite> select * from task;
1|test1|todo|2022-07-31 05:45:20|2022-07-31 05:45:20
2|test1|todo|2022-07-31 05:45:43|2022-07-31 05:45:43
```

### App Runnerã‚’åœæ­¢->å†é–‹ã—ã¦ã€è‡ªå‹•ã§ãƒªã‚¹ãƒˆã‚¢ã•ã‚Œã‚‹ã‹ç¢ºèª

åœæ­¢ã‚’ç¢ºèª
![ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ 2022-07-31 15 03 37](https://user-images.githubusercontent.com/12817245/182012570-deda09d6-32d6-4469-8d8e-8a8ce4513b55.png)
![ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ 2022-07-31 15 08 51](https://user-images.githubusercontent.com/12817245/182012679-430bb53f-5bbf-4a8d-8173-9e538f3fa32d.png)


å†é–‹å¾Œã€APIã§ãƒªã‚¹ãƒˆå–å¾—ã—ã¾ã™
```bash
$ curl -XGET https://<ãƒªã‚½ãƒ¼ã‚¹æ¯>.ap-northeast-1.awsapprunner.com/tasks
[{"id":1,"title":"test1","status":"todo","created":"2022-07-31 05:45:20"},{"id":2,"title":"test1","status":"todo","created":"2022-07-31 05:45:43"}]
```
ãƒ‡ãƒ¼ã‚¿ãŒè¿”å´ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‹ã‚‰ã€ãƒªã‚¹ãƒˆã‚¢ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚

CloudWatch Logsã‹ã‚‰å‡¦ç†ã®å†…å®¹ã‚’ç¢ºèªå‡ºæ¥ã¾ã™ã€‚
![ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ 2022-07-31 15 17 03](https://user-images.githubusercontent.com/12817245/182012978-647ccd30-3ec6-431f-853e-00cb3aa17df3.png)

# è£œè¶³

## AutoScaleè¨­å®š

:::message
2022/8/1ç¾åœ¨ã€`@aws-cdk/aws-apprunner-alpha`ã®L2 Constructã§ã¯æœ¬è¨­å®šã¯å‡ºæ¥ãªã„ãŸã‚ã€[L1 å®Ÿè£…ä¾‹](https://github.com/adamjkeller/apprunner-vpc-connector-demo/blob/main/cdk/lib/apprunner-vpc-demo-stack.ts)ã‚’å‚è€ƒã«ã™ã‚‹ã®ãŒè‰¯ã„ã¨æ€ã„ã¾ã™ã€‚
:::

è¤‡æ•°ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒèµ·å‹•ã™ã‚‹ã¨ã€æ•´åˆæ€§ãŒå–ã‚Œãªããªã‚‹ãŸã‚ã€AutoScaleè¨­å®šã®æœ€å¤§ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹æ•°ã¯1ã«ã™ã‚‹ã®ãŒè‰¯ã„ã¨æ€ã„ã¾ã™ã€‚(ã“ã‚ŒãŒæœ‰åŠ¹ã‹ã©ã†ã‹æœªç¢ºèª)

![ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ 2022-07-31 15 22 48](https://user-images.githubusercontent.com/12817245/182013058-439a1cd2-e745-4db3-a3ad-d5744cdb8e95.png)

## éå»ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’å¾©å…ƒã™ã‚‹

ä»Šå›Litestreamã®è¨­å®šã¯ã€30sé–“éš”ã§ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’ä½œæˆã—ã¦ã„ã¾ã™ã€‚

```yml:litestream.yml
dbs:
 - path: $DB_PATH
   replicas:
     - type: s3
       bucket: $REPLICATE_BUCKET_NAME
       path: replica
       region: ap-northeast-1
       retention: 120h # WALãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿æŒæœŸé–“
       snapshot-interval: 30s # ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆå–å¾—ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«
```

`litestream snapshots`ã§ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆä¸€è¦§ã‚’ç¢ºèªã§ãã¾ã™ã€‚`litestream restore`ã§ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆæŒ‡å®šãƒªã‚¹ãƒˆã‚¢ãŒå¯èƒ½ã§ã™ã€‚
ä¸‡ãŒä¸€ãƒ‡ãƒ¼ã‚¿ãŒæ®ç™ºã—ãŸå ´åˆã€ä¸€åº¦ã‚¢ãƒ—ãƒªã‚’åœæ­¢ã—ã¦ã€æ–°ã—ã„ä¸–ä»£ã‚’å‰Šé™¤ã™ã‚‹ã®ãŒè‰¯ã•ãã†ã§ã™ã€‚ã‚‚ã£ã¨ã‚ˆã„å¾©æ—§æ‰‹é †ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã‚‰ã€è¨˜äº‹ã«ã—ã‚ˆã†ã¨æ€ã„ã¾ã™ã€‚

```bash
$ litestream snapshots s3://dev-go-api-sqlite-replica-<ã‚¢ã‚«ã‚¦ãƒ³ãƒˆID>/replica
replica  generation        index  size  created
s3       3041d4387f582d1c  0      534   2022-07-31T00:41:49Z
s3       3041d4387f582d1c  1      534   2022-07-31T00:47:19Z
s3       3041d4387f582d1c  2      627   2022-07-31T00:47:49Z
s3       6e1bf4d6faafb5b8  0      534   2022-07-31T00:40:24Z

$ litestream restore -o test.db -generation 6e1bf4d6faafb5b8 s3://dev-go-api-sqlite-replica-<ã‚¢ã‚«ã‚¦ãƒ³ãƒˆID>/replica
```


# æ–™é‡‘
App Runnerã®æ–™é‡‘ã¯[å…¬å¼](https://aws.amazon.com/jp/apprunner/pricing/)ã‚’å¼•ç”¨ã—ã¾ã™ã€‚

> ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ†ã‚¹ãƒˆä¸­ã§ã€App Runner ã‚µãƒ¼ãƒ“ã‚¹ã§ã¯æ¯æ—¥ 2 æ™‚é–“ãšã¤ã€1 ç§’ã‚ãŸã‚Š 2 ãƒªã‚¯ã‚¨ã‚¹ãƒˆåˆ†ã®ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ãŒç™ºç”Ÿã—ã¾ã™ã€‚App Runner ã¯ã€å—ä¿¡ã—ãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†ã™ã‚‹ãŸã‚ã«ã‚µãƒ¼ãƒ“ã‚¹ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ 1 ã¤åˆ†ã®ã¿ã‚¹ã‚±ãƒ¼ãƒ«ã‚¢ãƒƒãƒ—ã—ã€æ¯æ—¥ 2 æ™‚é–“ã€ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ãƒ¡ãƒ¢ãƒªã‚’ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ã—ã¾ã™ã€‚ã‚³ã‚¹ãƒˆå‰Šæ¸›ã®ãŸã‚ã«ã€1 æ—¥ã®ã†ã¡æ®‹ã‚Šã® 22 æ™‚é–“ã¯ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä¸€æ™‚åœæ­¢ã—ã¾ã™ã€‚

4.80 USD/æœˆ

> æ¯æ—¥ 8 æ™‚é–“ã€æ¯ç§’ç´„ 80 å›ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒæ•£ç™ºçš„ã«ç™ºç”Ÿã—ã¾ã™ã€‚App Runner ã¯ã€å—ä¿¡ã—ãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†ã™ã‚‹ãŸã‚ã«ã‚µãƒ¼ãƒ“ã‚¹ã‚’ã‚³ãƒ³ãƒ†ãƒŠ 1 ã¤åˆ†ã®ã¿ã‚¹ã‚±ãƒ¼ãƒ«ã‚¢ãƒƒãƒ—ã—ã€æ¯æ—¥ 24 æ™‚é–“ã€ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ãƒ¡ãƒ¢ãƒªã‚’ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ã—ã¾ã™ã€‚

25.50 USD/æœˆ

ã†ãƒ¼ã‚“ã€ã€é«˜ã„...ã€‚Herokuã¨Cloudflare R2ã§åŒã˜æ§‹æˆã ã¨ã‚‚ã£ã¨å®‰ãã†...ã€‚


# ã•ã„ã”ã«

App Runnerã¯åˆã‚ã¦è©¦ã—ã¦ã¿ã¾ã—ãŸãŒã€æ‰‹è»½ã«ECRã‹ã‚‰ã‚³ãƒ³ãƒ†ãƒŠã®ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°å…¬é–‹ãŒå‡ºæ¥ã¦ã‚ˆã‹ã£ãŸã§ã™ã€‚CDKã§IaCãŒå‡ºæ¥ã‚‹ã¨ã“ã‚ã‚‚ã‚ˆã‹ã£ãŸã§ã™ã€‚å°‘ã—é‹ç”¨ã—ã¦ã¿ã¦ã€ã©ã‚Œãã‚‰ã„æ®ç™ºã™ã‚‹ã‹ãªã©ã€åˆ†ã‹ã£ãŸã“ã¨ãŒã‚ã£ãŸå ´åˆè¿½è¨˜ã—ã‚ˆã†ã¨æ€ã„ã¾ã™ã€‚

# å‚è€ƒè³‡æ–™

## ä»Šå›ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã—ãŸGoã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³

* [è©³è§£Goè¨€èªWebã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹ç™º](https://www.c-r.com/book/detail/1462)
  * [budougumi0617/go_todo_app](https://github.com/budougumi0617/go_todo_app)ã‚’ãƒ™ãƒ¼ã‚¹ã«SQLiteã«ä¸€éƒ¨ã‚³ãƒ¼ãƒ‰ã‚’å·®ã—æ›¿ãˆ

Goã§APIé–‹ç™ºã¯çµŒé¨“ãŒãªã‹ã£ãŸã®ã§ã€éå¸¸ã«åŠ©ã‹ã‚Šã¾ã—ãŸã€‚ã€‚

## Litestreamé–¢é€£

* [LiteStream ã‚’ã‚µã‚¤ãƒ‰ã‚«ãƒ¼æ§‹æˆã«ã—ãŸãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ°¸ç¶šåŒ–](https://zenn.dev/mattn/articles/fef682a8b204ac)
