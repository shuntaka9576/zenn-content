---
title: "[å°ãƒã‚¿]Webã‚¢ãƒ—ãƒªã®ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã«æƒ…å ±ã‚’ã‚»ã‚­ãƒ¥ã‚¢ã«æŒãŸã›ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒª"
emoji: "ğŸ—ï¸"
type: "tech"
topics: ["hapijsiron", "nodejs", "awslambda"]
published: true
---

# ã¯ã˜ã‚ã«

ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’å¾©å·ã—ã¦userIdã‚„æœŸé™æƒ…å ±ãŒå–å¾—ã§ãã‚Œã°ã€RDBMSã‚„KVSã§ç´ä»˜ã‘ã—ãªãã¦ã‚ˆã„ãŸã‚ã€çµæœãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯I/OãŒæ¸›ã‚Šãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¡ãƒªãƒƒãƒˆãŒå¤§ãã„ã§ã™ã€‚
[vvo/iron-session](https://github.com/vvo/iron-session)ãŒä¾¿åˆ©ãã†ã ãªã¨æ€ã„ã¤ã¤ã‚‚ã€Next.jsã‚„Express, Fastifyã¨ã„ã£ãŸãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‹ã‚‰ä½¿ã‚ã‚Œã‚‹ã“ã¨ãŒæƒ³å®šã•ã‚Œã¦ãŠã‚Šã€AWS Lambdaã§ä½¿ã„ãŸã„å ´åˆã«ä½¿ãˆãã†ãªé–¢æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚
ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’ç”Ÿæˆã™ã‚‹ã‚³ã‚¢éƒ¨ã¯[@hapijs/iron](https://github.com/hapijs/iron)ãªã®ã§ã€ã“ã¡ã‚‰ã‚’æ´»ç”¨ã™ã‚‹ã“ã¨ã§ä»»æ„ã®å ´æ‰€ã§å‘¼ã³å‡ºã™ã“ã¨ãŒã§ãã¾ã™ã€‚

:::message
Cloudflare workersã®å ´åˆã€V8 Isolatedã®ãŸã‚ã€Node.jsã®`crypto` `stream`ãŒå‘¼ã³å‡ºã›ãšä½¿ãˆã¾ã›ã‚“ã§ã—ãŸã€‚ [å‚è€ƒ](https://community.cloudflare.com/t/can-i-use-axios-in-a-worker/168139)

:::details wranglerã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Ÿè¡Œã—ãŸçµæœ

```bash
$ yarn wrangler pages dev --live-reload true ./public
(ä¸­ç•¥)
Compiling worker to "/var/folders/k_/ztkld5cj5z959s72w9r630200000gq/T/functionsWorker.js"...
âœ˜ [ERROR] Could not resolve "crypto"

    node_modules/@hapi/iron/lib/index.js:3:23:
      3 â”‚ const Crypto = require('crypto');
        â•µ                        ~~~~~~~~

  The package "crypto" wasn't found on the file system but is built into node. Are you trying to
  bundle for node? You can use "platform: 'node'" to do that, which will remove this error.

âœ˜ [ERROR] Could not resolve "crypto"

    node_modules/@hapi/cryptiles/lib/index.js:3:23:
      3 â”‚ const Crypto = require('crypto');
        â•µ                        ~~~~~~~~

  The package "crypto" wasn't found on the file system but is built into node. Are you trying to
  bundle for node? You can use "platform: 'node'" to do that, which will remove this error.

âœ˜ [ERROR] Could not resolve "stream"

    node_modules/@hapi/b64/lib/encoder.js:9:23:
      9 â”‚ const Stream = require('stream');
        â•µ                        ~~~~~~~~

  The package "stream" wasn't found on the file system but is built into node. Are you trying to
  bundle for node? You can use "platform: 'node'" to do that, which will remove this error.

âœ˜ [ERROR] Could not resolve "stream"

    node_modules/@hapi/b64/lib/decoder.js:9:23:
      9 â”‚ const Stream = require('stream');
        â•µ                        ~~~~~~~~

  The package "stream" wasn't found on the file system but is built into node. Are you trying to
  bundle for node? You can use "platform: 'node'" to do that, which will remove this error.

4 error(s) and 0 warning(s) when compiling Worker.
Build failed with 4 errors:
node_modules/@hapi/b64/lib/decoder.js:9:23: ERROR: Could not resolve "stream"
node_modules/@hapi/b64/lib/encoder.js:9:23: ERROR: Could not resolve "stream"
node_modules/@hapi/cryptiles/lib/index.js:3:23: ERROR: Could not resolve "crypto"
node_modules/@hapi/iron/lib/index.js:3:23: ERROR: Could not resolve "crypto"

If you think this is a bug then please create an issue at https://github.com/cloudflare/wrangler2/issues/new.
error Command failed with exit code 1.
info Visit https://yarnpkg.com/en/docs/cli/run for documentation about this command.
```

:::

AWS Lambdaã®ãƒ©ãƒ³ã‚¿ã‚¤ãƒ Node.js 14.Xã§ã¯å‹•ä½œç¢ºèªæ¸ˆã¿ã§ã™ã€‚

# ä½¿ã„æ–¹
[@hapi/ironå…¬å¼](https://hapi.dev/module/iron#example)ã‹ã‚‰æ‹å€Ÿã—ã¾ã™ã€‚

```bash:ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®å°å…¥
yarn add @hapi/iron
```

æœ€ä½32æ–‡å­—ä»¥ä¸Šã®æ–‡å­—åˆ—(ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰)ã‚’æŒ‡å®šã—ã¦ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’ç”Ÿæˆã—ã¾ã™ã€‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯ã‚­ãƒ¼ã‚¹ãƒˆã‚¢ã§ç®¡ç†ã™ã‚‹ã®ãŒè‰¯ã„ã§ã—ã‚‡ã†ã€‚

```ts:æš—å·åŒ–ã—ã¦å¾©å·åŒ–ã™ã‚‹ã‚µãƒ³ãƒ—ãƒ«
import * as Iron from '@hapi/iron';

const main = async () => {
  const obj = {
    a: 1,
    b: 2,
    c: [3, 4, 5],
    d: {
      e: 'f',
    },
  };

  const password = 'some_not_random_password_that_is_at_least_32_characters';

  try {
    const sealed = await Iron.seal(obj, password, Iron.defaults);
    console.log(sealed);
    const unsealed = await Iron.unseal(sealed, password, Iron.defaults);
    console.log(unsealed);
  } catch (err) {
    console.log(err.message);
  }
};
main().then(() => console.log('Success!'));
```

```bash
$ yarn ts-node src/h-api-iro/index.ts
# seal
Fe26.2**70a5e00e53b52fc23f74487a8c29ce555343a4b137e61377f1811a8ec3c7f332*hpCHKzlUapLmHsZF7qCHgQ*OcUgZ5TNIZagZftUeDGSrQIVrN5LK9pOONXyHjW6S6DfUi8RZi3eu3Tc4rcpftra**a13a0e731e45fdfc4287a95cdb7aac09fc0db10dd0a023ea735ff180bcee0457*cksLUdsRDoiKtanQWzNXt_KmL_VDBCsIuLt0PI0mrYY

# unseal
{ a: 1, b: 2, c: [ 3, 4, 5 ], d: { e: 'f' } }
```

å½“ç„¶ã§ã™ãŒã€AWS Lambda(Node 14.X)ã§ã‚‚å‹•ä½œã—ã¦ã„ã¾ã™ã€‚
![img](https://res.cloudinary.com/dkerzyk09/image/upload/v1645577871/blog/zenn/31f4c228de920b1776e8/k9lddcupn2qeu71cgkxf.png)


# ã•ã„ã”ã«
ä½¿ã„æ–¹é–“é•ã£ã¦ãŸã‚‰ã€ã”æŒ‡æ‘˜é ‚ã‘ãŸã‚‰ã¨æ€ã„ã¾ã™ã€‚ã€‚
